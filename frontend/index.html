<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Generation App</title>
</head>

<body>
    <h1>Video Generation App</h1>
    <form id="videoForm">
        <label for="textInput">Enter Text:</label>
        <textarea id="textInput" name="text" rows="4" cols="50" required></textarea>

        <label for="fileInput">Upload Text File (Optional):</label>
        <input type="file" id="fileInput" name="file" accept="text/*">

        <label for="videoInput">Upload Video File:</label>
        <input type="file" id="videoInput" name="video" accept=".mp4">

        <button type="submit">Generate Video</button>
    </form>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
        var txtFile = '';
        document.querySelector('#fileInput').addEventListener('input', function () {
            const file = this.files[0];
            let fr = new FileReader();
            fr.readAsText(file);
            fr.onload = () => {
                txtFile = fr.result;
            }
            fr.onerror = () => {
                console.log(fr.error);
            }
        });

        document.querySelector('#videoForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const textInput = document.getElementById('textInput').value;
            const fileInput = txtFile;
            const videoInput = document.getElementById('videoInput').files[0];
            const finalTxt = fileInput == '' ? textInput : fileInput;
            const formData = new FormData();
            formData.append('text', finalTxt);
            formData.append('video', videoInput);
            formData.forEach((value, key) => {
                console.log(value,key);
            });
            
            fetch('http://127.0.0.1:5000/generate-video', {
                method: "POST",
                body: formData,                
            }).
            then((result) => {
                console.log(result);
            }).catch((err) => {
                console.log(err);
            });         
        });

        async function generateVideo() {
            const textInput = document.getElementById('textInput').value;
            const fileInput = txtFile;
            const videoInput = document.getElementById('videoInput').files[0];
            const finalTxt = fileInput == '' ? textInput : fileInput;
            // const data = {
            //     text: finalTxt
            // }
            const formData = new FormData();
            formData.append('text', finalTxt);
            formData.append('video', videoInput);
            // for (const pair of formData.entries()) {
            //     console.log(pair[0] + ', ' + pair[1]);
            // }
            try {
                const response = await axios.post('http://127.0.0.1:5000/generate-video', formData, { responseType: 'blob' });
                const videoBlob = new Blob([response.data], { type: 'video/mp4' });
                const videoElement = document.createElement('video');
                videoElement.src = URL.createObjectURL(videoBlob);
                videoElement.controls = true;
                const existingVideos = document.querySelectorAll('video');
                existingVideos.forEach(el => el.remove());
                document.body.appendChild(videoElement);

            }
            catch (err) {
                console.log(error);
            }

        }

    </script>
</body>

</html>